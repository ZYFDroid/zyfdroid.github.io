<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberCinema v1 - åœ¨çº¿åŒæ­¥è§‚å½±</title>
    <!-- å¼•å…¥ MQTT.js -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #252525;
            --accent-color: #00e676;
            --text-color: #e0e0e0;
            --border-color: #444;
            --chat-width: 220px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; }

        /* é€šç”¨æ ·å¼ */
        .hidden { display: none !important; }
        .btn {
            background: var(--accent-color); border: none; padding: 8px 16px; 
            color: #000; font-weight: bold; cursor: pointer; border-radius: 4px;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        input, select {
            background: #333; border: 1px solid var(--border-color); 
            color: white; padding: 8px; border-radius: 4px; width: 100%; margin-bottom: 10px;
        }

        /* ç™»å½•é¡µ */
        #login-screen {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: radial-gradient(circle, #333 0%, #000 100%);
        }
        .login-box {
            background: var(--panel-bg); padding: 30px; border-radius: 8px; width: 400px;
            box-shadow: 0 0 20px rgba(0,230,118,0.2);
        }
        .login-box h2 { text-align: center; margin-bottom: 20px; color: var(--accent-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #aaa; }
        .row { display: flex; gap: 10px; }

        /* ä¸»ç•Œé¢ (è§†é¢‘åŒº + èŠå¤©åŒº) */
        #app-screen { display: flex; width: 100vw; height: 100vh; }
        
        /* è§†é¢‘åŒºåŸŸ */
        #video-section {
            flex: 1; position: relative; background: #000;
            display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* è‡ªå®šä¹‰æ§ä»¶ */
        .custom-controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px; display: flex; flex-direction: column; gap: 10px;
            opacity: 0; transition: opacity 0.3s;
        }
        #video-wrapper:hover .custom-controls { opacity: 1; }
        
        .progress-bar-container { width: 100%; height: 6px; background: #555; border-radius: 3px; cursor: pointer; position: relative; }
        .progress-bar-fill { height: 100%; background: var(--accent-color); width: 0%; border-radius: 3px; position: relative; }
        .progress-bar-handle {
            width: 12px; height: 12px; background: #fff; border-radius: 50%;
            position: absolute; right: -6px; top: -3px; display: none;
        }
        .progress-bar-container:hover .progress-bar-handle { display: block; }

        .control-row { display: flex; align-items: center; justify-content: space-between; }
        .control-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 1.2rem; margin-right: 15px; }
        .control-btn:hover { color: var(--accent-color); }
        .time-display { font-size: 0.8rem; font-variant-numeric: tabular-nums; margin-right: auto; }

        /* èŠå¤©ä¾§è¾¹æ  */
        #chat-sidebar {
            width: var(--chat-width); background: var(--panel-bg); border-left: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        
        /* ç”¨æˆ·åˆ—è¡¨ (ä¸ŠåŠéƒ¨åˆ†) */
        #user-list-panel {
            height: 35%; border-bottom: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        .panel-header { padding: 10px; background: #333; font-weight: bold; font-size: 0.9em; }
        #user-list { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.85em; }
        .user-item { display: flex; justify-content: space-between; padding: 4px 0; color: #ccc; }
        .user-item .host-badge { color: var(--accent-color); }

        /* èŠå¤©åŒºåŸŸ (ä¸‹åŠéƒ¨åˆ†) */
        #chat-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-toggle-btn {
            position: absolute; top: 0; right: 0; background: #333; border: none; 
            color: #fff; padding: 5px 8px; cursor: pointer; z-index: 10; font-size: 0.8em;
        }
        #chat-messages {
            flex: 1; overflow-y: auto; padding: 10px; font-size: 0.85em; display: flex; flex-direction: column; gap: 8px;
        }
        .chat-msg { word-wrap: break-word; line-height: 1.4; }
        .chat-meta { font-size: 0.75em; color: #888; margin-bottom: 2px; }
        .chat-text { color: #fff; }
        .system-msg { color: var(--accent-color); font-style: italic; font-size: 0.8em; text-align: center; }
        
        #chat-input-area { padding: 10px; background: #333; display: flex; gap: 5px; }
        #chat-input-area input { margin-bottom: 0; }
        
        /* çŠ¶æ€æŒ‡ç¤º */
        #status-bar {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6);
            padding: 5px 10px; border-radius: 4px; font-size: 0.8em; pointer-events: none;
            z-index: 5;
        }
        .role-host { color: var(--accent-color); font-weight: bold; }

        /* Toast æç¤º */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000;
        }
        #toast.show { opacity: 1; }
    </style>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-screen">
        <div class="login-box">
            <h2>CyberCinema v1</h2>
            
            <div class="form-group">
                <label>MQTT æœåŠ¡å™¨åœ°å€ (WebSocket)</label>
                <input type="text" id="mqtt-host" placeholder="ws://broker.example.com:8083/mqtt" value="">
            </div>
            
            <div class="row">
                <div class="form-group" style="flex:1">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="mqtt-user">
                </div>
                <div class="form-group" style="flex:1">
                    <label>å¯†ç </label>
                    <input type="password" id="mqtt-pass">
                </div>
            </div>

            <div class="form-group">
                <label>æˆ¿é—´ ID (æ— æ¨ªæ GUID)</label>
                <div class="row">
                    <input type="text" id="room-id" placeholder="è¾“å…¥æˆ–ç”Ÿæˆ">
                    <button class="btn" onclick="generateRoomId()">ç”Ÿæˆ</button>
                </div>
            </div>

            <div class="form-group">
                <label>ç”¨æˆ·æ˜µç§° (1-18å­—ç¬¦)</label>
                <input type="text" id="user-nick" maxlength="18" placeholder="ä½ çš„æ˜µç§°">
            </div>

            <div class="form-group">
                <label>æœ¬åœ°è§†é¢‘æ–‡ä»¶</label>
                <input type="file" id="video-file" accept="video/*">
            </div>

            <div class="row" style="margin-top: 20px;">
                <button class="btn" style="flex:1; background:#555" onclick="shareConfig()">åˆ†äº«é…ç½®</button>
                <button class="btn" style="flex:1; background:#555" onclick="receiveConfig()">æ¥æ”¶åˆ†äº«</button>
            </div>
            <div class="row" style="margin-top: 10px;">
                <button class="btn" style="flex:1" onclick="enterRoom()">è¿›å…¥æˆ¿é—´</button>
            </div>
        </div>
    </div>

    <!-- æ’­æ”¾ç•Œé¢ -->
    <div id="app-screen" class="hidden">
        <div id="video-section">
            <div id="video-wrapper" style="width:100%; height:100%; position:relative;">
                <video id="main-video"></video>
                
                <div class="custom-controls">
                    <div class="progress-bar-container" id="progress-bar">
                        <div class="progress-bar-fill" id="progress-fill"></div>
                        <div class="progress-bar-handle"></div>
                    </div>
                    <div class="control-row">
                        <div style="display:flex; align-items:center;">
                            <button class="control-btn" id="btn-play-pause">â–¶</button>
                            <button class="control-btn" id="btn-mute">ğŸ”Š</button>
                            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1" style="width:80px; margin:0 10px;">
                            <span class="time-display"><span id="curr-time">00:00</span> / <span id="total-time">00:00</span></span>
                        </div>
                        <div id="status-display" style="font-size: 0.8em; color: #aaa;">æœªè¿æ¥</div>
                    </div>
                </div>
            </div>
            <div id="status-bar">
                èº«ä»½: <span id="role-badge">--</span> | æˆ¿é—´: <span id="room-display">--</span>
            </div>
        </div>

        <div id="chat-sidebar">
            <div id="user-list-panel">
                <div class="panel-header">åœ¨çº¿ç”¨æˆ·</div>
                <div id="user-list">
                    <!-- ç”¨æˆ·åˆ—è¡¨é¡¹ -->
                </div>
            </div>
            <div id="chat-panel">
                <button class="chat-toggle-btn" onclick="toggleChat()">â–¼</button>
                <div id="chat-messages">
                    <div class="system-msg">æ¬¢è¿è¿›å…¥ CyberCinema</div>
                </div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="200">
                    <button class="btn" style="padding: 5px 10px;" onclick="sendChat()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast">æç¤ºä¿¡æ¯</div>

    <script>
        // --- å…¨å±€å˜é‡ ---
        const CONFIG = {
            msgTypes: {
                CHAT: 'chat',
                ENTER: 'enter',
                ENTER_RESP: 'enter_resp',
                BROADCAST: 'broadcast',
                ACTION: 'action',
                NEGOTIATE: 'negotiate',
                NEGOTIATE_RESP: 'neg_resp'
            }
        };

        let state = {
            clientId: '',
            username: '',
            roomTopic: '',
            isHost: false,
            users: {}, // { id: { nick, lastSeen, progress, state } }
            videoFile: null,
            videoBlobUrl: null,
            lastHeartbeat: 0, // æ”¶åˆ°å¹¿æ’­çš„æ—¶é—´æˆ³
            negotiateTimeout: null,
            justJoined: true // é˜²æ­¢åˆšè¿›å…¥æ—¶ç«‹å³è§¦å‘æˆ¿ä¸»ç¦»çº¿åˆ¤å®š
        };

        let mqttClient = null;
        let broadcastInterval = null;
        let video = document.getElementById('main-video');

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            // åˆå§‹åŒ–/è·å–å®¢æˆ·ç«¯ID
            let storedId = localStorage.getItem('cyber_cinema_uid');
            if (!storedId) {
                storedId = generateGUID();
                localStorage.setItem('cyber_cinema_uid', storedId);
            }
            state.clientId = storedId;

            // è‡ªåŠ¨å¡«å……ä¸Šæ¬¡çš„ä¿¡æ¯
            document.getElementById('mqtt-host').value = localStorage.getItem('last_host') || '';
            document.getElementById('mqtt-user').value = localStorage.getItem('last_user') || '';
            document.getElementById('room-id').value = localStorage.getItem('last_room') || '';
            document.getElementById('user-nick').value = localStorage.getItem('last_nick') || '';

            // ç»‘å®šè§†é¢‘æ§ä»¶äº‹ä»¶
            setupVideoControls();
        };

        // --- å·¥å…·å‡½æ•° ---
        function generateGUID() {
            return 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'.replace(/[x]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateRoomId() {
            document.getElementById('room-id').value = generateGUID();
        }

        // Base64 ç¼–ç  (æ”¯æŒä¸­æ–‡)
        function utf8_to_b64(str) {
            return window.btoa(unescape(encodeURIComponent(str)));
        }
        function b64_to_utf8(str) {
            return decodeURIComponent(escape(window.atob(str)));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function formatTime(seconds) {
            if(isNaN(seconds)) return "00:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        // --- ç™»å½•ä¸åˆ†äº«é€»è¾‘ ---
        function shareConfig() {
            const config = {
                h: document.getElementById('mqtt-host').value,
                u: document.getElementById('mqtt-user').value,
                p: document.getElementById('mqtt-pass').value,
                r: document.getElementById('room-id').value
            };
            const jsonStr = JSON.stringify(config);
            const encoded = utf8_to_b64(jsonStr);
            
            // å…¼å®¹æ€§å¤åˆ¶
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(encoded).then(() => {
                    showToast('é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(err => {
                    fallbackCopy(encoded);
                });
            } else {
                fallbackCopy(encoded);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if(successful) showToast('é…ç½®å·²å¤åˆ¶ (å…¼å®¹æ¨¡å¼)');
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            document.body.removeChild(textArea);
        }

        function receiveConfig() {
            navigator.clipboard.readText().then(text => {
                try {
                    const jsonStr = b64_to_utf8(text);
                    const config = JSON.parse(jsonStr);
                    if(config.h) document.getElementById('mqtt-host').value = config.h;
                    if(config.u) document.getElementById('mqtt-user').value = config.u;
                    if(config.p) document.getElementById('mqtt-pass').value = config.p;
                    if(config.r) document.getElementById('room-id').value = config.r;
                    showToast('é…ç½®å·²å¯¼å…¥');
                } catch (e) {
                    showToast('å‰ªè´´æ¿å†…å®¹æ— æ•ˆ');
                }
            }).catch(() => {
                showToast('æ— æ³•è¯»å–å‰ªè´´æ¿');
            });
        }

        function enterRoom() {
            const host = document.getElementById('mqtt-host').value;
            const user = document.getElementById('mqtt-user').value;
            const pass = document.getElementById('mqtt-pass').value;
            const roomId = document.getElementById('room-id').value;
            const nick = document.getElementById('user-nick').value;
            const fileInput = document.getElementById('video-file');

            if (!host || !roomId || !nick || fileInput.files.length === 0) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å­—æ®µå¹¶é€‰æ‹©è§†é¢‘');
                return;
            }

            // ä¿å­˜è®¾ç½®
            localStorage.setItem('last_host', host);
            localStorage.setItem('last_user', user);
            localStorage.setItem('last_room', roomId);
            localStorage.setItem('last_nick', nick);

            state.username = nick;
            state.roomTopic = `CyberCinema_v1/${roomId}`;
            state.videoFile = fileInput.files[0];
            state.videoBlobUrl = URL.createObjectURL(state.videoFile);
            state.justJoined = true; // æ ‡è®°åˆšåŠ å…¥
            state.lastHeartbeat = Date.now(); // åˆå§‹åŒ–å¿ƒè·³æ—¶é—´ï¼Œé˜²æ­¢åˆšè¿›å…¥å°±åˆ¤å®šæˆ¿ä¸»ç¦»çº¿

            // åˆ‡æ¢ç•Œé¢
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('room-display').innerText = roomId;

            // åŠ è½½è§†é¢‘
            video.src = state.videoBlobUrl;
            document.getElementById('total-time').innerText = formatTime(video.duration || 0);

            // è¿æ¥ MQTT
            connectMqtt(host, user, pass);
        }

        // --- MQTT é€»è¾‘ ---
        function connectMqtt(host, user, pass) {
            updateStatus('è¿æ¥ä¸­...');
            const options = {
                clientId: state.clientId,
                username: user,
                password: pass,
                clean: true,
                reconnectPeriod: 5000
            };

            mqttClient = mqtt.connect(host, options);

            mqttClient.on('connect', () => {
                updateStatus('å·²è¿æ¥');
                // è®¢é˜…æˆ¿é—´è¯é¢˜
                mqttClient.subscribe(state.roomTopic, { qos: 2 }, (err) => {
                    if (!err) {
                        // å‘é€è¿›å…¥æ¶ˆæ¯
                        publishMessage(CONFIG.msgTypes.ENTER, { nick: state.username });
                        startHostCheck();
                    }
                });
            });

            mqttClient.on('message', (topic, message) => {
                if (topic !== state.roomTopic) return;
                try {
                    const payload = JSON.parse(message.toString());
                    handleMessage(payload);
                } catch (e) {
                    console.error('æ¶ˆæ¯è§£æé”™è¯¯', e);
                }
            });

            mqttClient.on('error', (err) => {
                updateStatus('è¿æ¥é”™è¯¯');
                console.error(err);
            });
        }

        function publishMessage(type, data) {
            if (!mqttClient || !mqttClient.connected) return;
            const payload = {
                type: type,
                id: state.clientId,
                ts: Date.now(),
                ...data
            };
            // æ ¹æ®ç±»å‹å†³å®š QoS
            let qos = 0;
            if ([CONFIG.msgTypes.CHAT, CONFIG.msgTypes.ENTER, CONFIG.msgTypes.ENTER_RESP, CONFIG.msgTypes.ACTION, CONFIG.msgTypes.NEGOTIATE, CONFIG.msgTypes.NEGOTIATE_RESP].includes(type)) {
                qos = 2;
            }
            
            mqttClient.publish(state.roomTopic, JSON.stringify(payload), { qos });
        }

        // --- æ¶ˆæ¯å¤„ç†æ ¸å¿ƒ ---
        function handleMessage(msg) {
            const { type, id, ts, nick, time, state: playState, progress } = msg;

            // å¿½ç•¥è‡ªå·±çš„æ¶ˆæ¯
            if (id === state.clientId) return;

            switch (type) {
                case CONFIG.msgTypes.CHAT:
                    const chatContent = b64_to_utf8(msg.content);
                    addChatMessage(nick, chatContent, false);
                    break;

                case CONFIG.msgTypes.ENTER:
                    addSystemMessage(`${nick} åŠ å…¥äº†æˆ¿é—´`);
                    // å›åº”è¿›å…¥æˆ¿é—´å“åº”æ¶ˆæ¯ (åŒ…å«å½“å‰çŠ¶æ€)
                    publishMessage(CONFIG.msgTypes.ENTER_RESP, {
                        nick: state.username,
                        progress: video.currentTime,
                        state: video.paused ? 'paused' : 'playing'
                    });
                    // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œæ›´æ–°ç”¨æˆ·åˆ—è¡¨
                    if (state.isHost) updateUser(id, nick, Date.now());
                    break;

                case CONFIG.msgTypes.ENTER_RESP:
                    // å¦‚æœä¸æ˜¯æˆ¿ä¸»ï¼Œæ”¶åˆ°æ­¤æ¶ˆæ¯è¯´æ˜æœ‰äººåœ¨çº¿ï¼Œæˆ‘ä¸èƒ½æˆä¸ºæˆ¿ä¸»
                    // è°ƒæ•´è¿›åº¦ (åŒæ­¥)
                    if (!state.isHost && Math.abs(video.currentTime - progress) > 2) {
                         video.currentTime = progress;
                    }
                    if (!state.isHost && playState === 'playing' && video.paused) {
                        video.play();
                    } else if (!state.isHost && playState === 'paused' && !video.paused) {
                        video.pause();
                    }
                    updateUser(id, nick, Date.now());
                    break;

                case CONFIG.msgTypes.BROADCAST:
                    // æˆ¿ä¸»å¿ƒè·³
                    state.lastHeartbeat = Date.now();
                    if (state.isHost) {
                        // å¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œä½†æ”¶åˆ°äº†å¹¿æ’­ï¼Œè¯´æ˜æœ‰æ¯”æˆ‘æ›´æ—©çš„æˆ¿ä¸»å­˜åœ¨ï¼Œæˆ‘é™çº§ä¸ºè§‚ä¼—
                        becomeFollower();
                    }
                    
                    // æ›´æ–°æˆ¿ä¸»ä¿¡æ¯
                    updateUser(id, nick, Date.now());
                    
                    // åŒæ­¥æ£€æŸ¥ (5ç§’åå·®)
                    if (Math.abs(video.currentTime - progress) > 5) {
                        video.currentTime = progress;
                        // å‘é€åå•†å›å¤ (é€šçŸ¥æˆ¿ä¸»æˆ‘åŒæ­¥äº†)
                        publishMessage(CONFIG.msgTypes.NEGOTIATE_RESP, { 
                            nick: state.username, 
                            progress: video.currentTime 
                        });
                    }
                    // åŒæ­¥çŠ¶æ€
                    if (playState === 'playing' && video.paused) video.play();
                    if (playState === 'paused' && !video.paused) video.pause();
                    break;

                case CONFIG.msgTypes.NEGOTIATE_RESP:
                    // æ”¶åˆ°åå•†å›å¤ï¼Œæ›´æ–°ç”¨æˆ·åˆ—è¡¨
                    updateUser(id, nick, Date.now());
                    // å¦‚æœæˆ‘æ­£åœ¨å‘èµ·é€‰ä¸¾ï¼ˆæˆ–ç­‰å¾…é€‰ä¸¾ï¼‰ï¼Œæ”¶é›†æ­¤ä¿¡æ¯
                    // ç®€åŒ–é€»è¾‘ï¼šæ¯æ¬¡æ”¶åˆ°å›å¤éƒ½æ›´æ–°ç”¨æˆ·æ˜ å°„
                    break;

                case CONFIG.msgTypes.ACTION:
                    // ç”¨æˆ·åŠ¨ä½œ (åŒæ­¥) - æ‰€æœ‰äººéƒ½å¯ä»¥å‘é€ï¼Œæ‰€æœ‰äººéƒ½è¦æ‰§è¡Œ
                    if (msg.action === 'play') video.play();
                    if (msg.action === 'pause') video.pause();
                    if (msg.action === 'seek') video.currentTime = time;
                    break;
            }
        }

        // --- æˆ¿ä¸»/æˆ¿å®¢ çŠ¶æ€æœº ---
        
        // å¯åŠ¨æ£€æŸ¥ï¼Œå†³å®šæ˜¯å¦æˆä¸ºæˆ¿ä¸»
        function startHostCheck() {
            let checkCount = 0;
            const maxChecks = 3; // ç­‰å¾… 3 * 2 = 6ç§’ çœ‹æ˜¯å¦æœ‰å¿ƒè·³æˆ–å“åº”
            
            const checkTimer = setInterval(() => {
                checkCount++;
                // å¦‚æœè¿™æ®µæ—¶é—´æ²¡æ”¶åˆ°ä»»ä½•å¹¿æ’­ï¼Œä¹Ÿæ²¡æœ‰æ”¶åˆ° enter_respï¼Œåˆ™è®¤ä¸ºè‡ªå·±æ˜¯æˆ¿ä¸»
                // è¿™é‡Œç®€åŒ–åˆ¤æ–­ï¼šå¦‚æœæ²¡æœ‰æ”¶åˆ°éè‡ªå·±çš„ enter_respï¼Œä¹Ÿæ²¡æœ‰æ”¶åˆ° broadcast
                // ç”±äºæˆ‘ä»¬åˆšåŠ å…¥ï¼Œé€šå¸¸ä¼šæœ‰æ—§æˆ¿ä¸»çš„ broadcast æˆ–è€… åˆ«äººçš„ enter_resp
                // å¦‚æœæˆ‘ä»¬åªæ”¶åˆ°äº†è‡ªå·±çš„æ¶ˆæ¯ï¼ˆè¢«è¿‡æ»¤äº†ï¼‰ï¼Œé‚£ä¹ˆ users æ˜¯ç©ºçš„
                
                // åˆ¤æ–­ä¾æ®ï¼šusers é‡Œé¢æ˜¯å¦æœ‰åˆ«äºº
                const otherUsers = Object.keys(state.users).filter(k => k !== state.clientId);
                
                if (otherUsers.length === 0 && checkCount >= maxChecks) {
                    becomeHost();
                    clearInterval(checkTimer);
                } else if (otherUsers.length > 0) {
                    // å‘ç°äº†å…¶ä»–äººï¼Œæˆ‘ä¸æ˜¯æˆ¿ä¸»
                    becomeFollower();
                    clearInterval(checkTimer);
                }
            }, 2000);
        }

        function becomeHost() {
            if (state.isHost) return;
            state.isHost = true;
            updateStatus('ä½ æ˜¯æˆ¿ä¸» (æ­£åœ¨å¹¿æ’­è¿›åº¦)');
            
            // æ›´æ–°UIèº«ä»½æ ‡ç­¾
            const badge = document.getElementById('role-badge');
            badge.innerText = 'æˆ¿ä¸»';
            badge.className = 'role-host';
            
            startBroadcast();
            addSystemMessage('ä½ å·²æˆä¸ºæˆ¿ä¸»');
        }

        function becomeFollower() {
            if (!state.isHost) return;
            state.isHost = false;
            updateStatus('è§‚ä¼—æ¨¡å¼');
            
            // æ›´æ–°UIèº«ä»½æ ‡ç­¾
            const badge = document.getElementById('role-badge');
            badge.innerText = 'è§‚ä¼—';
            badge.className = '';
            
            stopBroadcast();
        }

        // æˆ¿ä¸»å¹¿æ’­å¿ƒè·³
        function startBroadcast() {
            if (broadcastInterval) clearInterval(broadcastInterval);
            
            const sendBroadcast = () => {
                if (!state.isHost || !mqttClient || !mqttClient.connected) return;
                
                // éšæœº 45-60ç§’
                const nextDelay = Math.random() * 15000 + 45000;
                
                publishMessage(CONFIG.msgTypes.BROADCAST, {
                    nick: state.username,
                    progress: video.currentTime,
                    state: video.paused ? 'paused' : 'playing'
                });

                broadcastInterval = setTimeout(sendBroadcast, nextDelay);
            };
            
            // ç«‹å³å‘é€ä¸€æ¬¡
            sendBroadcast();
        }

        function stopBroadcast() {
            if (broadcastInterval) clearTimeout(broadcastInterval);
            broadcastInterval = null;
        }

        // æˆ¿ä¸»ä¸¢å¤±æ£€æµ‹ (3-4åˆ†é’Ÿæ²¡æ”¶åˆ°å¹¿æ’­)
        // å®é™…ä¸Šåœ¨ handleMesssage BROADCAST é‡Œä¼šé‡ç½® lastHeartbeat
        setInterval(() => {
            if (state.isHost) return; // æˆ¿ä¸»ä¸éœ€è¦æ£€æµ‹

            // å¦‚æœåˆšåŠ å…¥ï¼Œè·³è¿‡æ£€æµ‹ï¼Œé˜²æ­¢è¯¯åˆ¤
            if (state.justJoined) {
                state.justJoined = false;
                return; 
            }

            const timeSinceHeartbeat = Date.now() - state.lastHeartbeat;
            // å¦‚æœè¶…è¿‡ 4 åˆ†é’Ÿ (240000 ms)
            if (timeSinceHeartbeat > 240000) {
                // å‘èµ·å•†é‡
                publishMessage(CONFIG.msgTypes.NEGOTIATE, { nick: state.username });
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´æ”¶é›†å›å¤ (ä¾‹å¦‚ 3ç§’)
                setTimeout(() => {
                    // æ‰¾å‡º ID ASCII æœ€å¤§çš„
                    const allIds = Object.keys(state.users);
                    allIds.push(state.clientId);
                    
                    // ç®€å•å­—ç¬¦ä¸²æ¯”è¾ƒ (ASCII)
                    const maxId = allIds.reduce((a, b) => a > b ? a : b);
                    
                    if (maxId === state.clientId) {
                        becomeHost();
                        addSystemMessage('åŸæˆ¿ä¸»ç¦»çº¿ï¼Œä½ å·²æ¥ä»»æˆ¿ä¸»');
                    }
                }, 3000);
                
                // é‡ç½® lastHeartbeat é˜²æ­¢é¢‘ç¹è§¦å‘ (ä¾‹å¦‚å»¶é•¿åˆ°2åˆ†é’Ÿï¼Œæˆ–è€…ä¾èµ–æ–°å¹¿æ’­æ¥æ›´æ–°)
                state.lastHeartbeat = Date.now() + 120000; 
            }
        }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡

        // --- UI æ›´æ–°ä¸æ§åˆ¶ ---

        function updateStatus(text) {
            document.getElementById('status-display').innerText = text;
        }

        function updateUser(id, nick, ts) {
            state.users[id] = { nick, ts };
            renderUserList();
        }

        function renderUserList() {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            Object.keys(state.users).forEach(id => {
                const u = state.users[id];
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `<span>${u.nick}</span> ${id === state.clientId ? '<span class="host-badge">(æˆ‘)</span>' : ''}`;
                list.appendChild(div);
            });
        }

        function toggleChat() {
            const msgs = document.getElementById('chat-messages');
            const btn = document.querySelector('.chat-toggle-btn');
            if (msgs.style.display === 'none') {
                msgs.style.display = 'flex';
                btn.innerText = 'â–¼';
            } else {
                msgs.style.display = 'none';
                btn.innerText = 'â–²';
            }
        }

        function addChatMessage(nick, text, isSelf) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-msg';
            if(isSelf) div.style.textAlign = 'right';
            
            div.innerHTML = `
                <div class="chat-meta">${nick}</div>
                <div class="chat-text">${text}</div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'system-msg';
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            // æ˜¾ç¤ºè‡ªå·±çš„æ¶ˆæ¯
            addChatMessage(state.username, text, true);
            
            // å‘é€ (Base64ç¼–ç å†…å®¹)
            publishMessage(CONFIG.msgTypes.CHAT, { 
                nick: state.username,
                content: utf8_to_b64(text) 
            });
            
            input.value = '';
        }

        // --- è§†é¢‘æ§åˆ¶é€»è¾‘ ---
        
        function setupVideoControls() {
            const btnPlay = document.getElementById('btn-play-pause');
            const btnMute = document.getElementById('btn-mute');
            const sliderVol = document.getElementById('volume-slider');
            const progressContainer = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');

            // æ’­æ”¾/æš‚åœ
            const togglePlay = () => {
                if (video.paused) video.play();
                else video.pause();
            };

            video.addEventListener('play', () => {
                btnPlay.innerText = 'â¸';
                // ç§»é™¤äº† isHost åˆ¤æ–­ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥å¹¿æ’­æ’­æ”¾åŠ¨ä½œ
                publishMessage(CONFIG.msgTypes.ACTION, { action: 'play' });
            });

            video.addEventListener('pause', () => {
                btnPlay.innerText = 'â–¶';
                // ç§»é™¤äº† isHost åˆ¤æ–­ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥å¹¿æ’­æš‚åœåŠ¨ä½œ
                publishMessage(CONFIG.msgTypes.ACTION, { action: 'pause' });
            });

            btnPlay.addEventListener('click', togglePlay);

            // éŸ³é‡
            btnMute.addEventListener('click', () => {
                video.muted = !video.muted;
                btnMute.innerText = video.muted ? 'ğŸ”‡' : 'ğŸ”Š';
            });
            sliderVol.addEventListener('input', (e) => {
                video.volume = e.target.value;
            });

            // è¿›åº¦æ›´æ–°
            video.addEventListener('timeupdate', () => {
                const pct = (video.currentTime / video.duration) * 100;
                progressFill.style.width = `${pct}%`;
                document.getElementById('curr-time').innerText = formatTime(video.currentTime);
            });

            video.addEventListener('loadedmetadata', () => {
                document.getElementById('total-time').innerText = formatTime(video.duration);
            });

            // æ‹–åŠ¨è¿›åº¦æ¡
            let isDragging = false;
            
            progressContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                updateProgressFromEvent(e);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) updateProgressFromEvent(e);
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    // ç§»é™¤äº† isHost åˆ¤æ–­ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥å¹¿æ’­è·³è½¬åŠ¨ä½œ
                    publishMessage(CONFIG.msgTypes.ACTION, { action: 'seek', time: video.currentTime });
                }
            });

            function updateProgressFromEvent(e) {
                const rect = progressContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                let pct = x / width;
                if (pct < 0) pct = 0;
                if (pct > 1) pct = 1;
                
                video.currentTime = pct * video.duration;
            }
        }
    </script>
</body>
</html>
